---
layout: post
title: Malware Analysis - Dexter Banker
categories: Recherches
---

![Intro-picture](/img/dexter/dexter banner.jpg){:class="img-responsive"}

### Sommaire

* Introduction
* Reconnaissance
* Overview
* Analyse
  * A) Mutex
  * B) Injection sous iexplorer.exe
  * C) Persistance
  * D) Options de sécurité IE
  * E) Keylogger SecureDLL.dll
  * F) Memory harvester
  * G) Exfiltration de données
  * H) Serveur de contrôle
* Indicateurs d'infection

### Introduction
Le sample analysé est le suivant:
> 140d24af0c2b3a18529df12dfbc5f6de

Celui-ci est téléchargeable sur la plateforme [Malshare](https://malshare.com/sample.php?action=detail&hash=140d24af0c2b3a18529df12dfbc5f6de)

_Attention, bien que le sample ne soit pas tout jeune, celui-ci reste très agressif et capable de causer des dégats à votre machine ou à vos données. Merci d'uniquement ouvrir le fichier dans un environnement contrôlé._

### Reconnaissance
• Le scan VirusTotal du fichier confirme dans un premier temps le caractère malicieux du fichier :
![picture](/img/dexter/A.PNG){:class="img-responsive"}
En croisant les appellations données par les différents antivirus du marché, il semblerait que le malware appartienne à la famille “Dexter” ou “Poxters”.
Il s’agit dans les deux cas d’un [banker/POS](https://en.wikipedia.org/wiki/Dexter_(malware)). L’analyse complète du binaire permettra de le catégoriser correctement par la suite.

• Au vu des différentes chaines de caractères observables dans l'exécutable, celui-ci ne semble pas packé.
L'utilitaire DIE ne détecte pas de signature de packers connus, et confirme le fait que le fichier soit bien l'actuel charge utile.
En revanche, le graphe d'entropie met en évidence le fait qu'une des sections du fichier posède une entropie particulièrement élevée:
![picture](/img/dexter/B.PNG){:class="img-responsive"}
Pour déterminer la source de cet entropie anormalement élevée dans un fichier brute, l'ouverture du fichier dans un éditeur héxadécimal permet de voir qu'un préfixe PE est présent au sein du fichier, mais que celui-ci semble obfusqué ou chiffré d'une certaine manière:
![picture](/img/dexter/C.PNG){:class="img-responsive"}
Le malware risque donc d'extraire un autre exécutable de lui-même à un certain moment.

• Dans un second temps, la liste des imports permet d’observer les fonctionnalités globales du malware sans rentrer dans le détail du fonctionnement de celui-ci.
La présence de nombreuses fonctions de manipulation mémoire (_OpenProcess_, _CreateRemoteThread_, _VirtualAlloc_ ou encore _HeapAlloc_) pourraient être le signe d’une injection en mémoire ou d’une manipulation de processus.

Au travers de la bibliothèque _WININET.dll_ et _URLMON.dll_ et via les fonctions _HttpSendRequest_, _InternetOpen_, _InternetGetCookie_, _InternetOpenUrl_ ou encore _InternetReadFile_ et _ObtainUserAgentString_, le malware va pouvoir interagir avec un serveur distant, télécharger des ressources additionnelles, ou même interroger les navigateurs internet de la machine infectée.

Outre les manipulations de clés de registre ou de fichiers sur le système, cette liste reste non-exhaustive, et permet unqiuement d’anticiper le comportement du binaire avant de l'analyser proprement.

• Pour terminer cette première phase de reconnaissance, les chaînes de caractères du binaire sont extraites. Puisque celles-ci ne sont pas obfusqués, et en les couplant avec les imports, de précieuses informations peuvent être extraites.

  ‣ La présence du chemin vers la clé de registre _“Software\Microsoft\Windows\CurrentVersion\Run”_ met potentiellement en évidence une technique de persistance adoptée par le malware.

  ‣ L’adresse IP _151.248.115.107_ et l’URL _/w19218317418621031041543/gateway.php_ pourraient servir de serveur de contrôle pour le malware, ou d’un point de téléchargement de composants additionnels.

  ‣ Un header HTTP est présent :
  > Mozilla/4.0(compatible; MSIE 7.0b; Windows NT 6.0)  
    POST  
    Content-Type:application/x-www-form-urlencoded

  Ceci confirme bien le fait que le malware va communiquer avec l'extérieur à un certain moment.
  
  ‣ Enfin de nombreuses références à une application Java sont faites, mêmes si elles n’ont aucune signification pour le moment :
  > Java Security Plugin  
  > %s\\%s  
  > javaplugin  
  > Java Security Plugin  
  > %s\\%s\\%s.exe  
  > Sun Java Security Plugin

### Overview
![picture](/img/dexter/overview.jpg){:class="img-responsive"}

### Analyse
L’analyse complète va permettre de détailler chronologiquement et en en profondeur toutes les actions et procédures employés par le malware.

#### A) Mutex
L’exécutable commence sa routine par créer un nouveau Mutex, au nom de _“WindowsServiceStabilityMutex”_:
![picture](/img/dexter/D.PNG){:class="img-responsive"}
![picture](/img/dexter/E.PNG){:class="img-responsive"}

#### B) Injection sous iexplorer.exe
L’exécutable Internet Explorer est dynamiquement localisé sur la machine, avant d’être lancé et mis en pause :
![picture](/img/dexter/F.PNG){:class="img-responsive"}
![picture](/img/dexter/G.PNG){:class="img-responsive"}
Le malware va ainsi pouvoir s’injecter dans un processus enfant d’Internet Explorer pour poursuivre ses actions malveillantes avec plus de discrétion. Les requêtes HTTP auront l’air plus légitimes par la suite si elles sont émises depuis un navigateur:
![picture](/img/dexter/H.PNG){:class="img-responsive"}
![picture](/img/dexter/I.PNG){:class="img-responsive"}

#### C) Persistance
Le malware va ensuite se copier dans l’exécutable _“javaplugin.exe”_ fraichement crée pour l’occasion, sous _“AppData\Roaming”_ :
![picture](/img/dexter/J.PNG){:class="img-responsive"}
![picture](/img/dexter/appdata.PNG){:class="img-responsive"}
Ensuite, la clé de registre liée au démarrage des programmes sur la machine est modifiée, sous _“SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run”_. Via cette clé de registre, le malware est certain de démarrer en même temps que la machine infectée :
![picture](/img/dexter/K.PNG){:class="img-responsive"}
La technique est classique et très sommaire, mais mise sur la légitimité d’un programme se faisant passer pour un plugin de sécurité Java. Ce genre de nom sert à décourager les utilisateurs non-avertis de retirer ce programme de la liste des démarrage automatique.

Le malware va également supprimer l'exécutable depuis lequel il a été lancé dans cette section du code.
Attention donc à en garder une copie dans le cadre d'une analyse.

A la fin de cette routine de persistance, un UUID est attribué à chaque machines infectés. Dans mon cas, il s’agit de l’UUID suivant :
![picture](/img/dexter/L.PNG){:class="img-responsive"}
Ma machine sera désignée par cette chaine de caractère lors de l’exfiltration de données. Cette valeur est stockée dans une clé de registre sous _SOFTWARE\\HelperSolution Software_, sous le nom de _“Digit”_:
![picture](/img/dexter/M.PNG){:class="img-responsive"}
![picture](/img/dexter/N.PNG){:class="img-responsive"}
A noter que cet UUID n’identifie pas réellement la machine de manière unique. Chaque instance du malware génèrera un nouvel UUID qui n’est pas rattachable à la machine depuis laquelle l’UID à été généré (selon la [documentation](https://docs.microsoft.com/en-us/windows/desktop/api/rpcdce/nf-rpcdce-uuidcreate) de la fonction _UuidCreate_). Ce n’est donc pas un mutex que l’opérateur du malware pourra utiliser pour identifier de manière unique une machine, mais uniquement un indentifiant temporaire.

#### D) Options de sécurité IE
Afin de changer les options de sécurité de navigateur Internet Explorer, certaines clés de registre vont êtres modifiées. La première modification de clé permet d’indiquer si un message d’avertissement doit être affichée par le navigateur quand une action malveillante est détectée. Cette fonction est désactivée par le malware:
![picture](/img/dexter/O.PNG){:class="img-responsive"}
![picture](/img/dexter/P.PNG){:class="img-responsive"}
Ensuite, la clé définissant les extensions de fichier ne présentants pas de risques au téléchargement est modifiée, de façon à inclure les fichier en _“.exe”_, _“.bat”_, _“.reg”_ et _“.vbs”_:
![picture](/img/dexter/Q.PNG){:class="img-responsive"}
![picture](/img/dexter/R.PNG){:class="img-responsive"}
Le programme prépare ici le terrain pour télécharger et exécuter des fichiers additionnels depuis le navigateur.

#### E) Keylogger SecureDLL.dll
Un DLL, au nom de _“SecureDLL.dll”_ est crée sur le bureau, en tant que fichier cachée :
![picture](/img/dexter/S.PNG){:class="img-responsive"}
Le contenu du DLL est copié dans le fichier, avant d'être chargé en mémoire. La haute entropie d’une zone d’une des sections est en fait lié à la présence du contenu chiffré de ce DLL dans le binaire d’origine.
![picture](/img/dexter/T.PNG){:class="img-responsive"}
A noter que l’auteur du malware à pensé à obfusquer le call de la fonction _RtlDecompressBuffer_ lors de la copie du contenu mémoire du dll vers le fichier, de façon à rendre moins évidente l’interception du dit dll:
![picture](/img/dexter/U.PNG){:class="img-responsive"}
Au final, il est plus simple d’attendre que le dll soit écrit sur le système, avant d’en récupérer une copie.
Le hash du dll extrait est
> “b5f429729f6ba45df4fc03b7b07a1fb8”.

Malgré son nom, fichier semble bel et bien dangereux:
![picture](/img/dexter/W.PNG){:class="img-responsive"}
_SecureDLL.dll_ est en fait le module servant de keylogger pour le malware Dexter. Le fonctionnement est classique, et le dump des touches est fait sous le fichier temporaire _“strokes.log”_.

Par la suite, un second fichiers temporaires _“tmp.log”_ est initialisé:
![picture](/img/dexter/X.PNG){:class="img-responsive"}
Le chemin de ces deux fichiers est ancré dans une clé de registre, déguisée en clé légitime sous le nom de “HelperSolution Software”. De cette façon, les autres modules du malware vont pouvoir interagir avec ces fichiers en récupérant dynamiquement ce path servants de point de rassemblement des données à exfiltrer.
![picture](/img/dexter/Y.PNG){:class="img-responsive"}
![picture](/img/dexter/Z.PNG){:class="img-responsive"}
Finalement, un hook est fait via la fonction _SetWindowsHookExA_, de façon à passer l’état du clavier à une fonction du dll malicieux (le keylogger).
![picture](/img/dexter/ZA.PNG){:class="img-responsive"}

#### F) Memory harvester
Une fois avoir droppé et lancé le fichier _SecureDLL.dll_, le malware va récupérer un copie de tous les processus lancés, ainsi que de leurs espaces mémoires et de leurs processus enfants, avec la fonction _CreateToolhelp32Snapshot_ (IDA Pro risque de ne pas aimer et de crasher à la suite de cette instruction). Les processus sont ensuites triés. Une liste de processus ne pouvant contenir des informations bancaires est hardcodée dans le binaire, de façon à les exclure de la recherches, et ne pas perdre de temps.

Les processus blacklistés sont les suivants:
![picture](/img/dexter/ZB.PNG){:class="img-responsive"}
Ensuite, le malware lance plusieurs threads à la suite:
Un premier thread responsable de prendre prendre des snapshot des processus toutes les X secondes est lancé:
![picture](/img/dexter/ZC.PNG){:class="img-responsive"}


Un deuxième thread servant de mécanisme de protection de la persistance est créé à la suite. Celui-ci vérifie que la clé de registre de persistance du malware ne soit pas modifiée. Si c’est le cas, il la remplace avec la valeur permettant au malware de démarrer avec la machine infectée:
Un premier thread responsable de prendre prendre des snapshot des processus toutes les X secondes est lancé:
![picture](/img/dexter/ZD.PNG){:class="img-responsive"}

Un autre thread est créé, de façon à détecter si la machine cherche à être éteinte (_DetectShutdownClass_).
Enfin, un dernier thread est créé, de façon à maintenir l’injection en mémoire du malware dans un processus Internet Explorer, même lorsque ce processus est manuellement fermé.
![picture](/img/dexter/ZE.PNG){:class="img-responsive"}

Ces quatres thread rendent le malware particulièrement agressif et résilient.

Pour récupérer des informations bancaire, le malware parcours les processus à la recherche des chaînes _“%B”_ et _“^”_, qui servent respectivement de préfixe et de délimiteur aux données contenu dans les bandes magnétiques des cartes bancaires.

De cette façon, le programme utilise sa propre regex pour trouver des informations en mémoire, à la différences d’autres bankers, qui utilisent presques tous des règles yara. La recherche est ainsi affiné, mais de nombreux faux-positifs sont susceptibles d'apparaître.

Quand de tels informations sont trouvées, celles ci sont extraites dans les fichiers temporaires, avant d’être envoyés au serveur de contrôle.

#### G) Exfiltration de données
Afin d’exfiltrer les données volés, le malware va contacter un serveur de contrôle hardcodé dans sa configuration, via une requête HTTP.

L'interception d’une de ces requêtes donne le résultat suivant :
Enfin, un dernier thread est créé, de façon à maintenir l’injection en mémoire du malware dans un processus Internet Explorer, même lorsque ce processus est manuellement fermé.
![picture](/img/dexter/ZF.PNG){:class="img-responsive"}
La routine d’exfiltration du malware est une fonction composées de plusieurs étapes linéaires consécutives:
![picture](/img/dexter/ZG.PNG){:class="img-responsive"}
Une requêtes HTTP POST est donc initiée en direction de l’adresse du serveur de contrôle (151.248.115.107) sur le port 80 :

Au préalable, un user-agent mozilla 4.0 est placé en mémoire, pour le header de la future requête web:
![picture](/img/dexter/ZH.PNG){:class="img-responsive"}
![picture](/img/dexter/ZI.PNG){:class="img-responsive"}
Ensuite, une phase de collecte d’information est faite de manière méthodique.

Dans un premier temps, c’est le nom d’utilisateur de la session qui est extrait :
![picture](/img/dexter/ZJ.PNG){:class="img-responsive"}
Suivi du nom de la machine:
![picture](/img/dexter/ZK.PNG){:class="img-responsive"}
Ensuite, l’architecture de la machine est récupérée:
![picture](/img/dexter/ZL.PNG){:class="img-responsive"}
La version Windows est elle aussi extraite, au moyen de la fonction GetVersionExA, _GetSystemInfo_ et _GetSystemNativeInfo_ de Kernel32.dll:
![picture](/img/dexter/ZM.PNG){:class="img-responsive"}
Puis, une comparaison est effectuée sur le résultats des commandes pour tomber dans les cas de figures suivants:
![picture](/img/dexter/ZN.PNG){:class="img-responsive"}
Le graphe de la fonction illustre bien le comportement (récolte d’informations dans les premiers blocs, puis comparaison des résultats avec des paternes indiquant la version de Windows) :
![picture](/img/dexter/ZO.PNG){:class="img-responsive"}
Les fichiers _debug.log_ et _tmp.log_ sont ensuite créés à l'emplacement depuis lequel le malware est lancé.

Le malware va ensuite charger en mémoire le contenu du fichier _debug.log_, puis le parser, de façon à former une requête HTTP pouvant contenir les arguments suivants:
![picture](/img/dexter/ZP.PNG){:class="img-responsive"}
Les informations sont chiffrés avec une simple clé XOR (6 caractères alphanumériques en minuscules et majuscules), avant d’êtres concaténés, et envoyés au serveur de contrôle.
![picture](/img/dexter/xor.PNG){:class="img-responsive"}
#### H) Serveur de contrôle

Malheureusement, le serveur de contrôle (151.248.115.107) du malware correspondant à ce sample n’existe plus, et celui-ci pointe désormais sur une plateforme d’hébergement de serveurs russes.

En se renseignant sur le passif de cette adresse, le caractère malicieux de celle-ci ne fait aucuns doutes:
![picture](/img/dexter/ZQ.PNG){:class="img-responsive"}
Les différentes pages “gateway.php” sont ce qui semble être des interfaces de contrôle du malware. Enfin, il est possible de confirmer le fait que ce serveur est bien celui d’où provient spécifiquement le binaire analysé:
![picture](/img/dexter/ZR.PNG){:class="img-responsive"}
Cette adresse IP semble aussi avoir servi de serveur de contrôle pour les binaires aux hashs suivants:
> e1f07bef2bf727d9f6be772bfcbf629e 2017-04-20 01:47:22
> 140d24af0c2b3a18529df12dfbc5f6de 2016-11-04 23:26:16
> 215d113ceb0df7ac7f6edfd080f15dd7 2017-04-20 01:39:40

(D’après [Threatminer](https://www.threatminer.org/host.php?q=151.248.115.107))

### Indicateurs d'infection
Hash du binaire (_Win33.exe_) : _140d24af0c2b3a18529df12dfbc5f6de_  
Hash du module Keylogger (_SecureDLL.dll_) : _b5f429729f6ba45df4fc03b7b07a1fb8_  
Serveur de contrôle : 151.248.115.107  
Clé de registre : _Software\Microsoft\Windows\CurrentVersion\Run\SunJavaSecurityPlugin_  
Clé de registre : _Software\HelperSolutions Software\val1_  
Clé de registre : _Software\HelperSolutions Software\val2_  
Clé de registre : _Software\HelperSolutions Software\Digit_  
Fichier système : _C:\Users\HomardBoy\AppData\Roaming\Java Security plugin\javaplugin.exe_  

Yara rule:

{% highlight yara linenos %}

rule DexterPOS
{
     meta:
          Author = “HomardBoy”
          description = “Dexter Point Of Sale Malware, StarDust version”
          sample = “140d24af0c2b3a18529df12dfbc5f6de”
     strings:
          $path = “/gateway.php”
          $version = “StarDust”
          $java = “Java Security Plugin”
          $UserAgnet = “Mozilla/4.0(compatible; MSIE 7.0b; Windows NT 6.0)”
}
{% endhighlight %}

Snort rule:

![picture](/img/dexter/snort.PNG){:class="img-responsive"}
