---
layout: post
title: Malware Analysis - RogueRobin
categories: MalwareAnalysis
hidden: true
---
This blog post is available in french [here](https://guillaumeorlando.github.io/RogueRobin-malware-analysis).
![Intro-picture](/img/DarkHydrus/darkhydrus_banner.jpg){:class="img-responsive"}

### Summary

* Introduction
* Recon
* DarkHydrus APT
* Analysis
  * A) Anti-VM and anti-debug
  * B) Persistence method
  * C) Data exfiltration
    * 1) DNS data exfiltration overview
    * 2) Exfiltration
  * D) Information gathering
  * E) C2 Instruction handler
* Indicators of compromise

### Introduction
The analysed sample have the following hash:
> 2f22d521a1945d02380057a636e1032b

The file can be downloaded on [VirusBay](https://beta.virusbay.io/sample/browse/2f22d521a1945d02380057a636e1032b).

_Usual disclaimer: This sample is theoretically harmless, because the C2 servers are down, and the trojan does not have any destructive capabilities. A huge care is still required while dealing with this sample._

### Recon
In some way, this sample is still stealthy regarding anti-virus detection, even if this one is few month old (from [VirusTotal](https://www.virustotal.com/#/file/6c014eddb7622e5e48c3e9d10a6ebaa02b2fe7b3318ab4f2d4daf1a619ed913c)):
![picture](/img/DarkHydrus/0.PNG){:class="img-responsive"}

Special mention for ClamAV, Microsoft-Defender and Ikarus, which were able to precisely spot this malware:
![picture](/img/DarkHydrus/01.PNG){:class="img-responsive"}
![picture](/img/DarkHydrus/02.PNG){:class="img-responsive"}
![picture](/img/DarkHydrus/03.PNG){:class="img-responsive"}

The binary file does not seem packed, in light of the file’s entropy:
![picture](/img/DarkHydrus/B.PNG){:class="img-responsive"}

The fact that this malware was written in a [.Net](https://fr.wikipedia.org/wiki/Microsoft_.NET) language is going to be a big benefit for the following analysis:
![picture](/img/DarkHydrus/A.PNG){:class="img-responsive"}
A [.Net](https://fr.wikipedia.org/wiki/Microsoft_.NET) malware is not compiled and can be easily reverse. The original source code of the program can be retrieved in this case.

Finally, the malware is not packed nor obfuscated, which lead to the full disclosure of the program’s strings. Those strings can help to understand the basic functionality of the malware, but nothing noteworthy for us.

### DarkHydrus APT
The [RogueRobin](https://malpedia.caad.fkie.fraunhofer.de/details/ps1.roguerobin) trojan is assign to an emerging threat actor call [DarkHydrus](https://attack.mitre.org/groups/G0079/). This group appeared for the first time in 2016, and have conducted two malicious campaigns.

[The first campaign](https://www.cybersecurity-review.com/news-august-2018/new-actor-darkhydrus-targets-middle-east-with-open-source-phishing/) was based on the open-source tool [Phishery](https://github.com/ryhanson/phishery), and aim to steal governmental and political groups related credentials through spear phishing, in middle east.

[The second DarkHydrus campaigns](https://www.cybersecurity-review.com/news-january-2019/darkhydrus-abuses-google-drive-to-spread-roguerobin-trojan/) unveil the RogueRobin malware. This one target political groups based in the middle east, in june 2018. This trojan is tied up to geopolitics objectives, and the [DarkHydrus](https://attack.mitre.org/groups/G0079/) threat actor may reappear in the near future.

### Analysis
### A) Anti-VM and anti-debug
Before doing anything, the RogueRobin trojan is actively going to look for a virtualized or an analysis environnement.

First thing first, the BIOS serial-number of the computer is gathered in order to look for a virtualized environment.

This first detection stage is based on some external powershell commands. If a virtualization firm is detected ([VmWare](https://www.vmware.com/), [VirtualBox](https://www.virtualbox.org/wiki/Downloads), [BOSH](https://www.bosh.io/docs/), [Qemu](https://www.qemu.org/) or [Xen](https://xenproject.org/)), the program immediately exit:
![picture](/img/DarkHydrus/M.PNG){:class="img-responsive"}

Next, the computer's manufacturer is gather in order to try to find if the computer run inside a virtual machine, with the following powershell command:
![picture](/img/DarkHydrus/N.PNG){:class="img-responsive"}

On a VmWare machine, here is the result of the powershell command:
![picture](/img/DarkHydrus/O.PNG){:class="img-responsive"}

Then, the malware check the virtual memory quantity on the system. If there is less than 3Go of RAM, the program’s flaw is stopped. Usually, virtual machines or sandbox does not require much virtual memory, and this RAM quantity is not used anymore on personal desktop. This check is relevant.
![picture](/img/DarkHydrus/P.PNG){:class="img-responsive"}
(_‘ulong’ var = 2900000000u’_)

To carry on, the same type of check is done with the number of processor core on the system. If there is only one core, the computer is marked as suspect:
![picture](/img/DarkHydrus/Q.PNG){:class="img-responsive"}

Afterwards, the name of the running process are check against a short blacklist. The [Sysinternals](https://docs.microsoft.com/en-us/sysinternals/) tools ([procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) and [procexp](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer)  for instance) and the [Wireshark](https://www.wireshark.org/) tools are part of the blacklist:
![picture](/img/DarkHydrus/R.PNG){:class="img-responsive"}

At the end, the malware check is a debugger is being used:
![picture](/img/DarkHydrus/S.PNG){:class="img-responsive"}

This last check close the anti-analysis techniques used by the RogueRobin trojan.

### B) Persistence method
In order to stay hidden on a compromise system, RogueRobin copy itself in the _AppData_ folder, under the name ‘_OneDrive.exe_’.
![picture](/img/DarkHydrus/T.PNG){:class="img-responsive"}
![picture](/img/DarkHydrus/U.PNG){:class="img-responsive"}

To survive after a reboot, the malicious file is added into the startup folder, by creating a shortcut from the previous ‘_OneDrive.exe_’ file:
![picture](/img/DarkHydrus/W.PNG){:class="img-responsive"}
![picture](/img/DarkHydrus/V.PNG){:class="img-responsive"}

### C) Data exfiltration
In order to send the first client message to the C2 server, the RogueRobin malware start by extracting the malicious process ID, with the _Process.GetCurrentProcess().Id_ function:
![picture](/img/DarkHydrus/X.PNG){:class="img-responsive"}

With the analysed sample, the returned PID is _3856_. This unique number is then going to be converted in a character string, using a linear function that apply a specific letter to each corresponding numbers of the extracted PID:
![picture](/img/DarkHydrus/Y.PNG){:class="img-responsive"}

In my case, the given string is “_kpmn_”. This string is prepend by the letter “_a_”, and the letter “_c_” is appended to the whole string. At the end, the final string became “_akpmnc_”:
![picture](/img/DarkHydrus/Z.PNG){:class="img-responsive"}

This string will now be used as an identifier for the infected system. The malicious server is noticed of a new client when it receives this ID. RogueRobin features covers an original exfiltration method, which abuse the [DNS protocol](https://tools.ietf.org/html/rfc1034).. This technique is going to be discussed below.

### 1) DNS data exfiltration overview
DNS data exfiltration is a way to extract data through the DNS protocol. The DNS protocol is based on a decentralized architecture that allow an external computer to convert a URL into an IP, before reaching this particular IP address (in order to access a web service for instance). When a browser / a system want to reach “_www.exemple.com_”, it first needs to convert the URL into the IP address of the web server hosting the “exemple.com” index page. First, one of the few top-level DNS ([Top-Level Domain](https://en.wikipedia.org/wiki/Top-level_domain) or TLD, those who are dealing with generic domain like “_.com_”, “_.org_”, “_.fr_”, etc …) is asked to return the address of the DNS server in charge of the “_exemple.com_” domain. Then, this DNS server is going to be queried about the IP address of the host that have the hostname “_www_”, in the “_exemple.com_” domain. Knowing this IP address, the source system can now reach the web server, and request the needed web informations. That’s basically how the DNS protocol work: every domain zone are checked from the larger zone (_.com_) to the specific host (_www_).

[DNS exfiltration](https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html) involve a compromise DNS server that have the authority over a malicious domain. In our case, by trying to resolve “_akpmnc.exemple.com_”, the DNS server from the “_exemple_” domain is going to look for the host “akpmnc” in his domain. Even if this host does not exist, the string “_akpmnc_” is going to reach the “_exemple.com_” DNS server, and if this server is own by a malicious adversary, the string can basically get exfiltrated and interpreted.

[DNS data exfiltration](https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html) rely on a compulsory protocol that is [hardly ever checked or monitored](http://www.caida.org/~nevil/Bojan_Zdrnja_CompSci780_Project.pdf).

### 2) Exfiltration
First thing, the DNS cache of the host is cleaned with the “_ipconfig /flushdns_” command:
![picture](/img/DarkHydrus/ZA.PNG){:class="img-responsive"}

This command is transparent from the user perspective:
![picture](/img/DarkHydrus/ZB.PNG){:class="img-responsive"}

The legit tool “_nslookup.exe_” is used to practice the DNS data exfiltration. The [nslookup](https://en.wikipedia.org/wiki/Nslookup) command is initialized from several available DNS method and several exfiltration domain:

The available DNS method are the following:
![picture](/img/DarkHydrus/ZD.PNG){:class="img-responsive"}

And the malicious domain to reach are the following:
![picture](/img/DarkHydrus/ZE.PNG){:class="img-responsive"}

In this way, the first command executed by the malware is this one:
![picture](/img/DarkHydrus/ZF.PNG){:class="img-responsive"}

It is worth noting that a new anti-debug technique is being used before actually perform the command (even if this technique is almost useless from the analysis point of view). If a debugger is detected by the malware, then none of the malicious domains are reached, and a bunch of garbage data are sent to a legitimate google domain:
![picture](/img/DarkHydrus/ZG.PNG){:class="img-responsive"}

The numeric string “_676f6f646c75636b_” is in fact the hexadecimal value for “goodluck” in ASCII. It looks like the malware author tried to fool our analysis !
![picture](/img/DarkHydrus/ZH.PNG){:class="img-responsive"}

If everything is fine, the exfiltration command generated earlier is executed on the system:
![picture](/img/DarkHydrus/ZI.PNG){:class="img-responsive"}
![picture](/img/DarkHydrus/ZJ.PNG){:class="img-responsive"}

In order to check if the request was accurately delivered to the C2, the malware is parsing the nslookup output:
![picture](/img/DarkHydrus/ZK.PNG){:class="img-responsive"}

A new command is going to be generated from another DNS method associate with a new domain name until one of the C2 host is responding.

Because the specific sample that I am working on don’t have any alive C2 server by the time of the analysis, I was forced to fake one of the DNS domain with a tool called ApateDNS. This utility answer every outgoing DNS request by a positive message:
![picture](/img/DarkHydrus/ZL.PNG){:class="img-responsive"}

From this point, the trojan think that one of the domain is up, and can move forward by assigning the boolean “_True_” into the “_flag_” variable:
![picture](/img/DarkHydrus/ZM.PNG){:class="img-responsive"}

The DNS server’s answer is then saved for later, with the aim of interpreting it in the future, and extracting some instructions from the malware's command and control server.

### D) Information gathering
Some basic informations from the infected system are obtains, like the IP address of the computer, the hostname, the domain name and the active username
![picture](/img/DarkHydrus/ZN.PNG){:class="img-responsive"}

The next information is about the user privilege from which the program were launched from. A small design mistake appear in this function, and make it only working on a system that have english languages settings. This function is the following:
![picture](/img/DarkHydrus/ZP.PNG){:class="img-responsive"}

It returns one of those 3 values:
![picture](/img/DarkHydrus/tab1-eng.PNG){:class="img-responsive"}

The mistake in the function’s design rely on the fact that the administrator group of a Windows system have a name based on the language settings. For instance, on an english-based system, the administrator group is simply called “_Administrators_”. But on a french system, the administrator group is “_Administrateurs_”. Each language have it own admin translation in the local Windows groups. But in this sample, the powershell command that is used is for the hardcoded group “_Administrators_”, wich create a small conflict:
![picture](/img/DarkHydrus/ZO.PNG){:class="img-responsive"}

The malware is not able to gather the execution privileges on a non-english system.

Those informations are chained together, with some extra details, like the rest time used by the malware, or if the persistence method have been used:
![picture](/img/DarkHydrus/ZQ.PNG){:class="img-responsive"}

The final string containing the identification datas are convert in hexadecimal:
![picture](/img/DarkHydrus/ZR.PNG){:class="img-responsive"}

If the malware is build with the “_x_mode_” value, then RogueRobin will initiate it exfiltration routine through a shared Google Docs, in order to hide it outgoing traffic :
![picture](/img/DarkHydrus/ZS.PNG){:class="img-responsive"}

If not, data are exfiltrated through the DNS protocol technics.

### E) C2 Instruction handler
When the basics informations regarding the infected client are sended back to the C2 server, the malware stay in hibernation, waiting for some instruction coming from some orders. When a specific instruction is sended from the server to a client, this one can be issued from a Google Docs page (the same that is used for the exfiltration part), or through DNS requests.

After getting the data transmitted from the server, the content is parsed then convert from hexadecimal to ASCII text. Each new incoming instructions are sent to the “_taskHandler_” function, which is going to execute the specific instruction in a new thread:
![picture](/img/DarkHydrus/ZT.PNG){:class="img-responsive"}

The available instruction for the malware are the following:
* _^kill_
A running process is terminated, based on his PID:
![picture](/img/DarkHydrus/ZU.PNG){:class="img-responsive"}

* _^\\$fileDownload_
A local file from the infected computer is sent to the command & control server:
![picture](/img/DarkHydrus/ZV.PNG){:class="img-responsive"}

* _^\\$importModule_
Execute a given powershell command. This command is then stored inside a so called “module” list:
![picture](/img/DarkHydrus/ZW.PNG){:class="img-responsive"}

* _^\\$ClearModules_
The previous module list is remove:
![picture](/img/DarkHydrus/ZX.PNG){:class="img-responsive"}

* _^\\$file_Upload_
A resource from the server is download on the system:
![picture](/img/DarkHydrus/ZY.PNG){:class="img-responsive"}

* _^testmode_
The communications between the malware and the server are checked, through a DNS request containing the string “_testmode_”:
![picture](/img/DarkHydrus/ZZ.PNG){:class="img-responsive"}

* _^exit_
The parent process of the malware is killed:
![picture](/img/DarkHydrus/ZZA.PNG){:class="img-responsive"}

* _^slp_
The value that is used as a timer between each action is update (between each DNS request for instance):
![picture](/img/DarkHydrus/ZZB.PNG){:class="img-responsive"}

* _^changeConfig_
Update some malware’s informations, like the C2 domain list:
![picture](/img/DarkHydrus/ZZC.PNG){:class="img-responsive"}

Some others informations, like the DNS methods used, the maximum number of request to issue before considering a C2 server as down and the presence of junk data into the exfiltrated ones, can be changed.

* _^showConfig_
Return the trojan's configuration:
![picture](/img/DarkHydrus/ZZD.PNG){:class="img-responsive"}

* _^\\$x_mode_
Turn on (or turn off) the ability to communicate through a Google Doc file:
![picture](/img/DarkHydrus/ZZE.PNG){:class="img-responsive"}

Therefore, the RogueRobin malware is able to act as a dropper (and so, being used as an infection vector for others harmful malwares), but also insure some basic trojan functionalities, like stealing file and execute remote commands. With the ability to use a Google Docs as an interface between the malware and the C2 server, or with the DNS data exfiltration methods, this sample is original in its communication features.

A great care has been taken during the design of the malware, which is consistent concerning the targeted institutions. The lake of obfuscation technique or even of a simple packer is really odd regarding the complexity of the techniques being used, and make the anti-analysis part almost useless for the analyst. As far as the choice of a compiled-language for the malware … Why taking time to write some anti-VM functions when those same function can be read as plaintext during the analysis ?

![picture](/img/DarkHydrus/pepe.jpg){:class="img-responsive"}

### Indicateurs d’infection
RogueRobin sample hash : _2f22d521a1945d02380057a636e1032b_

Malicious domains: _0ffice365.agency_, _0nedrive.agency_, _corewindows.agency_, _microsoftonline.agency_, _onedrive.agency_, _sharepoint.agency_, _skydrive.agency_, _0ffice365.life_, _0ffice365.services_, _skydrive.services_

Filesystem : _%APPDATA%\OneDrive.exe_

Filesystem: _C:\Users\<user name>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\OneDrive.lnk_

![picture](/img/DarkHydrus/yara.PNG){:class="img-responsive"}
