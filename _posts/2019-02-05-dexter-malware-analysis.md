---
layout: post
title: Malware Analysis - Dexter Banker
categories: Recherches
---

![Intro-picture](/img/dexter/intro.PNG){:class="img-responsive"}

### 0. Sommaire

* Introduction
* Reconnaissance
* Analyse
  * A) Mutex
  * B) Injection sous iexplorer.exe
  * C) Persistance
  * D) Options de sécurité IE
  * E) Keylogger SecureDLL.dll
  * F) Memory harvester
  * G) Serveur de contrôle
* Indicateurs d'infection

### 1. Introduction
Le sample analysé est le suivant:
> 140d24af0c2b3a18529df12dfbc5f6de

Celui-ci est téléchargeable sur la plateforme [Malshare](https://malshare.com/sample.php?action=detail&hash=140d24af0c2b3a18529df12dfbc5f6de)

_Attention, bien que le sample ne soit pas tout jeune, celui-ci reste très agressif et capable de causer des dégats à votre machine ou à vos données. Merci d'uniquement ouvrir le fichier dans un environnement contrôlé._

### 2. Reconnaissance
• Le scan VirusTotal du fichier confirme dans un premier temps le caractère malicieux du fichier :
![picture](/img/dexter/A.PNG){:class="img-responsive"}
En croisant les appellations données par les différents antivirus du marché, il semblerait que le malware appartienne à la famille “Dexter” ou “Poxters”.
Il s’agit dans les deux cas d’un [banker/POS](https://en.wikipedia.org/wiki/Dexter_(malware)). L’analyse complète du binaire permettra de le catégoriser correctement par la suite.

• Au vu des différentes chaines de caractères observables dans l'exécutable, celui-ci ne semble pas packé.
L'utilitaire DIE ne détecte pas de signature de packers connus, et confirme le fait que le fichier soit bien l'actuel charge utile.
En revanche, le graphe d'entropie met en évidence le fait qu'une des sections du fichier posède une entropie particulièrement élevée:
![picture](/img/dexter/B.PNG){:class="img-responsive"}
Pour déterminer la source de cet entropie anormalement élevée dans un fichier brute, l'ouverture du fichier dans un éditeur héxadécimal permet de voir qu'un préfixe PE est présent au sein du fichier, mais que celui-ci semble obfusqué ou chiffré d'une certaine manière:
![picture](/img/dexter/C.PNG){:class="img-responsive"}
Le malware risque donc d'extraire un autre exécutable de lui-même à un certain moment.

• Dans un second temps, la liste des imports permet d’observer les fonctionnalités globales du malware sans rentrer dans le détail du fonctionnement de celui-ci.
La présence de nombreuses fonctions de manipulation mémoire (_OpenProcess_, _CreateRemoteThread_, _VirtualAlloc_ ou encore _HeapAlloc_) pourraient être le signe d’une injection en mémoire ou d’une manipulation de processus.

Au travers de la bibliothèque _WININET.dll_ et _URLMON.dll_ et via les fonctions _HttpSendRequest_, _InternetOpen_, _InternetGetCookie_, _InternetOpenUrl_ ou encore _InternetReadFile_ et _ObtainUserAgentString_, le malware va pouvoir interagir avec un serveur distant, télécharger des ressources additionnelles, ou même interroger les navigateurs internet de la machine infectée.

Outre les manipulations de clés de registre ou de fichiers sur le système, cette liste reste non-exhaustive, et permet unqiuement d’anticiper le comportement du binaire avant de l'analyser proprement.

• Pour terminer cette première phase de reconnaissance, les chaînes de caractères du binaire sont extraites. Puisque celles-ci ne sont pas obfusqués, et en les couplant avec les imports, de précieuses informations peuvent être extraites.

  ‣ La présence du chemin vers la clé de registre _“Software\Microsoft\Windows\CurrentVersion\Run”_ met potentiellement en évidence une technique de persistance adoptée par le malware.

  ‣ L’adresse IP _151.248.115.107_ et l’URL _/w19218317418621031041543/gateway.php_ pourraient servir de serveur de contrôle pour le malware, ou d’un point de téléchargement de composants additionnels.

  ‣ Un header HTTP est présent :
  > Mozilla/4.0(compatible; MSIE 7.0b; Windows NT 6.0)

  > POST

  > Content-Type:application/x-www-form-urlencoded

  Ceci confirme bien le fait que le malware va communiquer avec l'extérieur à un certain moment.
  ‣ Enfin de nombreuses références à une application Java sont faites, mêmes si elles n’ont aucune signification pour le moment :
  > Java Security Plugin

  > %s\\%s

  > javaplugin

  > Java Security Plugin

  > %s\\%s\\%s.exe
  
  > Sun Java Security Plugin

### 3. Analyse
L’analyse complète va permettre de détailler chronologiquement et en en profondeur toutes les actions et procédures employés par le malware.

#### A) Mutex
L’exécutable commence sa routine par créer un nouveau Mutex, au nom de _“WindowsServiceStabilityMutex”_:
![picture](/img/dexter/D.PNG){:class="img-responsive"}
![picture](/img/dexter/E.PNG){:class="img-responsive"}

#### B) Injection sous iexplorer.exe
L’exécutable Internet Explorer est dynamiquement localisé sur la machine, avant d’être lancé et mis en pause :
![picture](/img/dexter/F.PNG){:class="img-responsive"}
![picture](/img/dexter/G.PNG){:class="img-responsive"}
Le malware va ainsi pouvoir s’injecter dans un processus enfant d’Internet Explorer pour poursuivre ses actions malveillantes avec plus de discrétion. Les requêtes HTTP auront l’air plus légitimes par la suite si elles sont émises depuis un navigateur:
![picture](/img/dexter/H.PNG){:class="img-responsive"}
![picture](/img/dexter/I.PNG){:class="img-responsive"}

#### C) Persistance
Le malware va ensuite se copier dans l’exécutable _“javaplugin.exe”_ fraichement crée pour l’occasion, sous _“AppData\Roaming”_ :
![picture](/img/dexter/J.PNG){:class="img-responsive"}
Ensuite, la clé de registre liée au démarrage des programmes sur la machine est modifiée, sous _“SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run”_. Via cette clé de registre, le malware est certain de démarrer en même temps que la machine infectée :
![picture](/img/dexter/K.PNG){:class="img-responsive"}
La technique est classique et très sommaire, mais mise sur la légitimité d’un programme se faisant passer pour un plugin de sécurité Java. Ce genre de nom sert à décourager les utilisateurs non-avertis de retirer ce programme de la liste des démarrage automatique.

Le malware va également supprimer l'exécutable depuis lequel il a été lancé dans cette section du code.
Attention donc à en garder une copie dans le cadre d'une analyse.

A la fin de cette routine de persistance, un UUID est attribué à chaque machines infectés. Dans mon cas, il s’agit de l’UUID suivant :
![picture](/img/dexter/L.PNG){:class="img-responsive"}
Ma machine sera désignée par cette chaine de caractère lors de l’exfiltration de données. Cette valeur est stockée dans une clé de registre sous _SOFTWARE\\HelperSolution Software_, sous le nom de _“Digit”_:
![picture](/img/dexter/M.PNG){:class="img-responsive"}
![picture](/img/dexter/N.PNG){:class="img-responsive"}
A noter que cet UUID n’identifie pas réellement la machine de manière unique. Chaque instance du malware génèrera un nouvel UUID qui n’est pas rattachable à la machine depuis laquelle l’UID à été généré (selon la [documentation](https://docs.microsoft.com/en-us/windows/desktop/api/rpcdce/nf-rpcdce-uuidcreate) de la fonction _UuidCreate_). Ce n’est donc pas un mutex que l’opérateur du malware pourra utiliser pour identifier de manière unique une machine, mais uniquement un juste temporaire.



#### D) Options de sécurité IE
#### E) Keylogger SecureDLL.dll
#### F) Memory harvester
#### G) Serveur de contrôle
### 4. Indicateurs d'infection
