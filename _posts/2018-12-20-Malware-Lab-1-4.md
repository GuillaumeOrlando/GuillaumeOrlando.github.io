---
layout: post
title: Practical Malware Analysis - Lab 01x4
categories: MalwareAnalysis
---

Cette série de writeups couvre les différents exercices du lab "_Practical Malware Analysis_". Ce premier chapitre à pour but d'introduire à l’analyse statique basique de différents samples.

### Lab 1-4 (Lab01-04.exe)
> 1 - Does either file match any existing antivirus signatures

Le binaire est reconnu comme malveillant:
![image-left](/img/PMA/chap1/04/AA.PNG)

> 2 - Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.

Le binaire ne semble pas packé d’après la taille des différentes sections:
![image-left](/img/PMA/chap1/04/AAB.PNG)
Enfin, _PEiD_ confirme le fait que le programme n’est pas packé:
![image-left](/img/PMA/chap1/04/AC.PNG)

> 3 - Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

Le programme va visiblement être capable de modifier les permissions de certaines ressources:
![image-left](/img/PMA/chap1/04/AD.PNG)
Mais aussi de manipuler le filesystem de la machine infectée, en créant, déplaçant, localisant et ouvrant des fichiers. Le programme va donc très certainement laisser des traces sur un système infecté.
![image-left](/img/PMA/chap1/04/AE.PNG)
Chose très importante à noter: En cherchant à afficher la liste des chaînes de caractères présentes dans le binaire, je me suis rendu-compte que celui-ci contenait un autre programme, de par la présence de trop nombreuses sections a des endroits différents du code, et au double prologue “_This program cannot be run in DOS mode._”.

Afin d’extraire le second programme, j’utilise RessourceHacker, qui identifie bien un autre binaire au sein du premier.
Ce deuxième programme semble bien plus court, et comporte notamment une fonction capables de télécharger des ressources distantes sur une machine infectée:
![image-left](/img/PMA/chap1/04/AF.PNG)

> 4 - What host- or network-based indicators could be used to identify this malware on infected machines?

Le premier programme fait allusion au programme “_winlogon.exe_”:
![image-left](/img/PMA/chap1/04/AG.PNG)
Mais aussi à l'exécutable suivant:
![image-left](/img/PMA/chap1/04/AH.PNG)
Au programme “_winup.exe_”:
![image-left](/img/PMA/chap1/04/AI.PNG)
Le deuxième programme fait allusion au programme “_wupdmgrd.exe_”. À noter que l'orthographe ne correspond pas à l'exécutable homonyme natif aux systèmes Windows:
![image-left](/img/PMA/chap1/04/AJ.PNG)
Enfin, une URL est présente dans les chaînes du programme:
![image-left](/img/PMA/chap1/04/AK.PNG)
Sachant que ce deuxième binaire est capable de télécharger des ressources, il est possible d’imaginer que le logiciel malveillant va contacter cette adresse à un certain moment.

Au vu des informations acquises et des fonctions utilisés, il semblerait que le premier programme puisse déposer le second en le camouflant au sein d’exécutables Windows légitimes, de façon à le rendre persistant. Le deuxième module va certainement, quant à lui, télécharger des ressources additionnels.

###Analyse complète:
###Stage 1:
Le malware commence par charger les différentes fonctions issues de DLL externes dont il a besoin pour fonctionner, à savoir _EnumProcessModules_, _GetModuleBaseNameA_ et _EnumProcess_ depuis _psapi.dll_:
![image-left](/img/PMA/chap1/04/A.PNG)

Les fonctions importées sont appelées sans argument afin de tester leur fonctionnement:
![image-left](/img/PMA/chap1/04/B.PNG)

Si l’import des fonctions s’est déroulé sans problèmes, une liste des processus tournant sur le système est récupérée:
![image-left](/img/PMA/chap1/04/C.PNG)

Le programme boucle ensuite sur la totalité des processus retournées. Pour chaque processus, le PID sera extrait et passé en argument à la fonction _func_FindInjectionProcess_:
![image-left](/img/PMA/chap1/04/D.PNG)![image-left](/img/PMA/chap1/04/A.PNG)

Cette fonction cherche le processus “_winlogon.exe_” parmi l’entièreté des processus systèmes:
![image-left](/img/PMA/chap1/04/E.PNG)

Si le processus "_winlogon.exe_" est trouvé, le malware s’injecte dedans:
![image-left](/img/PMA/chap1/04/F.PNG)

Ensuite, l'exécutable situé sous "_C:\Windows\system32\wupdmgr.exe_" est sauvegardé sous "_"%APPDATA%\winup.exe_" :
![image-left](/img/PMA/chap1/04/G.PNG)

Pour terminer, le malware va charger la ressource interne “_BIN/101_” (qui est en fait un autre exécutable). Le fichier précédemment déplacé va être recréé ( _C:\Windows\system32\wupdmgr.exe_), et le contenu de la ressource chargée y sera écrite:
![image-left](/img/PMA/chap1/04/H.PNG)

Enfin, l’exécutable fraîchement droppé est exécuté:
![image-left](/img/PMA/chap1/04/I.PNG)

Ce lot d’instructions clos le fonctionnement de ce programme.

En résumé, le binaire malicieux est un droper, qui va s’injecter sous le processus _winlogon.exe_. Une fois injecté, le malware extrait un second fichier de ses ressources internes. Le contenu de ce deuxième fichier est placé à la place du binaire légitime _wupdmgr.exe_, avant d’être lancé.



### Stage 2:
Le stage 2 du malware va droit au but. Celui-ci lance l’instance de _winup.exe_ désormais sous "_%APPDATA%_":
![image-left](/img/PMA/chap1/04/J.PNG)

Une ressource externe est ensuite téléchargée depuis l’URL “_http://www.practicalmalwareanalysis.com/updater.exe_” via la fonction _URLDownloadToFileA_. Le fichier téléchargé va remplacer l’ancienne version de wupdmgrd.exe sous “_C:\windows\system32_”, avant d’être lui aussi exécuté:
![image-left](/img/PMA/chap1/04/K.PNG)

Le cœur du binaire se content ici uniquement de télécharger un nouveau composant et de le placer en sécurité avant de l'exécuter.
